{{#section 'styles'}}
<title>Dashboard - Posts</title>
<style>
    .posts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        gap: 1rem;
    }

    .search-box {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .post-preview-img {
        width: 80px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid var(--dark);
    }

    .post-preview-placeholder {
        width: 80px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--darker);
        border-radius: 4px;
        border: 1px solid var(--dark);
    }

    .post-preview-placeholder i {
        font-size: 1.5rem;
        color: var(--text-light);
        opacity: 0.5;
    }

    .post-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(33, 150, 243, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        transition: all 0.3s cubic-bezier(.4, 0, .2, 1);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 24px rgba(33, 150, 243, 0.2);
        background: rgba(255, 255, 255, 0.08);
    }

    .stat-card h3 {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-light);
    }

    .stat-card .value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 0.5rem;
        color: var(--light);
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
        .post-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
    }

    @media (max-width: 768px) {
        .posts-header {
            flex-direction: column;
            align-items: stretch;
        }

        .posts-header .btn {
            width: 100%;
        }

        .post-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            padding: 1rem;
        }

        .stat-card h3 {
            font-size: 0.8rem;
        }

        .stat-card .value {
            font-size: 1.25rem;
        }

        .search-box {
            flex-direction: column;
            align-items: stretch;
        }

        .post-preview-img,
        .post-preview-placeholder {
            width: 60px;
            height: 45px;
        }

        .post-preview-placeholder i {
            font-size: 1.2rem;
        }
    }

    @media (max-width: 480px) {
        .post-stats {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .stat-card {
            padding: 0.75rem;
        }

        .stat-card h3 {
            font-size: 0.75rem;
        }

        .stat-card .value {
            font-size: 1rem;
        }

        .post-preview-img,
        .post-preview-placeholder {
            width: 45px;
            height: 35px;
        }

        .post-preview-placeholder i {
            font-size: 0.9rem;
        }
    }
</style>
{{/section}}

<div class="content-header">
    <h1 class="content-title">Posts Management</h1>
    <a href="/dashboard/posts/create" class="btn btn-primary">
        <i class="fas fa-plus"></i> Create New Post
    </a>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(33, 150, 243, 0.2); color: var(--primary);">
            <i class="fas fa-newspaper"></i>
        </div>
        <div class="stat-info">
            <h3>Total Posts</h3>
            <div class="value">{{totalPosts}}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(67, 233, 123, 0.2); color: var(--success);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
            <h3>Published</h3>
            <div class="value">{{publishedPosts}}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(255, 209, 102, 0.2); color: var(--warning);">
            <i class="fas fa-edit"></i>
        </div>
        <div class="stat-info">
            <h3>Drafts</h3>
            <div class="value">{{draftPosts}}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(0, 184, 148, 0.2); color: var(--accent);">
            <i class="fas fa-folder"></i>
        </div>
        <div class="stat-info">
            <h3>Categories</h3>
            <div class="value">{{totalCategories}}</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="filters-container">
        <div class="search-box">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search posts..." id="searchPosts">
        </div>

        <div class="filter-options">
            <div class="filter-group">
                <label>Status:</label>
                <select id="statusFilter" class="form-select">
                    <option value="all">All Status</option>
                    <option value="published">Published</option>
                    <option value="draft">Draft</option>
                    <option value="private">Private</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Category:</label>
                <select id="categoryFilter" class="form-select">
                    <option value="all">All Categories</option>
                    {{#each categories}}
                    <option value="{{this.name}}">{{this.name}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="filter-group">
                <label>Sort by:</label>
                <select id="sortFilter" class="form-select">
                    <option value="date-desc">Date (Newest)</option>
                    <option value="date-asc">Date (Oldest)</option>
                    <option value="views-desc">Views (Most)</option>
                    <option value="views-asc">Views (Least)</option>
                    <option value="title">Title</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-container">
        {{#if posts}}
        <table class="table">
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Post Details</th>
                    <th>Category</th>
                    <th>Created</th>
                    <th>Author</th>
                    <th>Views</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{#each posts}}
                <tr data-created-at="{{created_at}}" data-views="{{views}}">
                    <td style="width: 100px;">
                        {{#if preview_image}}
                        <img src="{{preview_image}}" alt="Preview" class="post-preview-img">
                        {{else}}
                        <div class="post-preview-placeholder">
                            <i class="fas fa-image"></i>
                        </div>
                        {{/if}}
                    </td>
                    <td style="min-width: 300px;">
                        <div style="font-weight: 500; color: var(--light);">{{title}}</div>
                        <div style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.25rem;">{{#if excerpt}}{{truncate
                            (stripMarkdown excerpt) 120}}{{else}}{{truncate (stripMarkdown content_markdown)
                            120}}{{/if}}</div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            {{#if categories}}
                            {{#each (split categories ',') as |category|}}
                            <span
                                style="background: rgba(0, 184, 148, 0.2); color: var(--accent); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">
                                {{trim category}}
                            </span>
                            {{/each}}
                            {{else}}
                            <span style="color: var(--text-light); font-style: italic; font-size: 0.875rem;">No category</span>
                            {{/if}}
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 0.875rem; color: var(--text);">{{formatDate created_at}}</div>
                    </td>
                    <td>
                        <div style="font-size: 0.875rem; color: var(--text);">{{author_name}}</div>
                    </td>
                    <td>
                        <div style="font-size: 0.875rem; color: var(--text);">{{views}}</div>
                    </td>
                    <td>
                        <span
                            class="status-badge {{#if (eq status 'published')}}status-published{{else if (eq status 'draft')}}status-draft{{else}}status-private{{/if}}">
                            <i
                                class="fas {{#if (eq status 'published')}}fa-check-circle{{else if (eq status 'draft')}}fa-clock{{else}}fa-lock{{/if}} mr-1"></i>
                            {{#if (eq status 'published')}}Published{{else if (eq status
                            'draft')}}Draft{{else}}Private{{/if}}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/post/{{slug}}" class="btn btn-sm btn-primary" target="_blank" title="View">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/dashboard/posts/edit/{{id}}" class="btn btn-sm btn-primary" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="deletePost({{id}})" class="btn btn-sm btn-danger" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
        {{else}}
        <div style="text-align: center; padding: 3rem;">
            <div style="margin-bottom: 1rem;">
                <i class="fas fa-newspaper" style="font-size: 3rem; color: var(--text-light); opacity: 0.5;"></i>
            </div>
            <h3 style="color: var(--light); margin-bottom: 1rem;">No posts found</h3>
            <p style="color: var(--text-light); margin-bottom: 2rem;">Create your first post to get started!</p>
            <a href="/dashboard/posts/create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Create New Post
            </a>
        </div>
        {{/if}}
    </div>
</div>

<script>
    // Filter and sort functionality
    function filterAndSortPosts() {
        const searchText = document.getElementById('searchPosts').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const sortFilter = document.getElementById('sortFilter').value;
        const tbody = document.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // Apply filters
        rows.forEach(row => {
            const title = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const categories = Array.from(row.querySelector('td:nth-child(3)').querySelectorAll('span'))
                .map(span => span.textContent.trim().toLowerCase());
            const status = row.querySelector('.status-badge').textContent.trim().toLowerCase();

            const matchesSearch = title.includes(searchText) || categories.some(cat => cat.includes(searchText));
            const matchesStatus = statusFilter === 'all' || status.includes(statusFilter.toLowerCase());
            const matchesCategory = categoryFilter === 'all' ||
                categories.some(cat => cat === categoryFilter.toLowerCase());

            row.style.display = matchesSearch && matchesStatus && matchesCategory ? '' : 'none';
        });

        // Sort visible rows
        const visibleRows = rows.filter(row => row.style.display !== 'none');
        const hiddenRows = rows.filter(row => row.style.display === 'none');
        
        visibleRows.sort((a, b) => {
            switch (sortFilter) {
                case 'date-desc':
                case 'date-asc': {
                    const aDate = new Date(a.getAttribute('data-created-at'));
                    const bDate = new Date(b.getAttribute('data-created-at'));
                    return sortFilter === 'date-desc' ? bDate - aDate : aDate - bDate;
                }
                case 'views-desc':
                case 'views-asc': {
                    const aViews = parseInt(a.getAttribute('data-views'), 10);
                    const bViews = parseInt(b.getAttribute('data-views'), 10);
                    return sortFilter === 'views-desc' ? bViews - aViews : aViews - bViews;
                }
                case 'title': {
                    const aTitle = a.querySelector('td:nth-child(2) div:first-child').textContent.trim().toLowerCase();
                    const bTitle = b.querySelector('td:nth-child(2) div:first-child').textContent.trim().toLowerCase();
                    return aTitle.localeCompare(bTitle);
                }
                default:
                    return 0;
            }
        });

        // Clear tbody and append sorted visible rows first, then hidden rows
        tbody.innerHTML = '';
        visibleRows.forEach(row => tbody.appendChild(row));
        hiddenRows.forEach(row => tbody.appendChild(row));
    }

    // Add event listeners for all filter controls
    document.getElementById('searchPosts').addEventListener('input', filterAndSortPosts);
    document.getElementById('statusFilter').addEventListener('change', filterAndSortPosts);
    document.getElementById('categoryFilter').addEventListener('change', filterAndSortPosts);
    document.getElementById('sortFilter').addEventListener('change', filterAndSortPosts);

    function deletePost(id) {
        if (confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            fetch(`/dashboard/api/posts/${id}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete post. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the post.');
                });
        }
    }
</script>